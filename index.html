<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quemador de Tokens Solana</title>
    <!-- Precargar las bibliotecas para mejorar la carga -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.73.0/lib/index.iife.min.js" as="script">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/@solana/spl-token@0.3.6/lib/index.iife.min.js" as="script">
    
    <!-- Incluir el mismo CSS que antes -->
    <style>
      /* Tus estilos actuales... */
      /* Estilos globales */
      body {
        margin: 0;
        padding: 0;
        background-color: #121212;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      }
    
      #solana-token-burner {
        color: #fff;
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        background-color: #000;
        border-radius: 16px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      }
    
      /* El resto de tus estilos... */
    </style>
</head>
<body>
    <!-- El mismo HTML que antes -->
    <div id="solana-token-burner">
      <!-- Contenido HTML... -->
    </div>

    <!-- SOLUCIÓN: Cargar bibliotecas usando un CDN alternativo y con manejo de errores mejorado -->
    <script>
      // Inicializar estado global
      window.SolanaQuemadorState = {
        loadingStatus: 'pending',
        web3Loaded: false,
        splTokenLoaded: false
      };
      
      // Mostrar mensajes de estado
      function showStatus(message, isError = false) {
        const errorEl = document.getElementById('stb-error');
        if (!errorEl) return;
        
        errorEl.textContent = message;
        errorEl.style.display = 'block';
        
        if (!isError) {
          setTimeout(() => {
            errorEl.style.display = 'none';
          }, 3000);
        }
        
        console.log(isError ? 'ERROR: ' : 'INFO: ', message);
      }
      
      // Cargar script con reintentos
      function loadScriptWithRetry(url, alternativeUrl, callback, errorCallback, retries = 2) {
        let currentTry = 0;
        let currentUrl = url;
        
        function attemptLoad() {
          const script = document.createElement('script');
          script.type = 'text/javascript';
          script.src = currentUrl;
          
          script.onload = function() {
            console.log('Cargado exitosamente:', currentUrl);
            callback();
          };
          
          script.onerror = function() {
            currentTry++;
            console.warn(`Error cargando ${currentUrl}, intento ${currentTry}/${retries + 1}`);
            
            if (currentTry === 1 && alternativeUrl) {
              // Cambiar a URL alternativa en el primer error
              console.log('Intentando con URL alternativa:', alternativeUrl);
              currentUrl = alternativeUrl;
              attemptLoad();
            } else if (currentTry <= retries) {
              // Reintentar con la URL actual
              console.log('Reintentando carga en 1 segundo...');
              setTimeout(attemptLoad, 1000);
            } else {
              // Falló todos los intentos
              console.error('Fallaron todos los intentos de carga para:', url);
              errorCallback();
            }
          };
          
          document.body.appendChild(script);
        }
        
        attemptLoad();
      }
      
      // Inicializar la aplicación cuando ambas bibliotecas estén listas
      function checkAndInitialize() {
        if (window.SolanaQuemadorState.web3Loaded && window.SolanaQuemadorState.splTokenLoaded) {
          window.SolanaQuemadorState.loadingStatus = 'loaded';
          showStatus('Bibliotecas cargadas correctamente. Inicializando aplicación...');
          
          // Pequeña pausa para asegurar que todo esté listo
          setTimeout(() => {
            initSolanaBurner();
          }, 500);
        }
      }
      
      // Cargar las bibliotecas
      document.addEventListener('DOMContentLoaded', function() {
        showStatus('Cargando bibliotecas de Solana...');
        
        // Cargar Web3.js primero
        loadScriptWithRetry(
          'https://cdn.jsdelivr.net/npm/@solana/web3.js@1.73.0/lib/index.iife.min.js',
          'https://unpkg.com/@solana/web3.js@1.73.0/lib/index.iife.min.js',
          function() {
            window.SolanaQuemadorState.web3Loaded = true;
            showStatus('Solana Web3 cargado. Cargando SPL Token...');
            
            // Ahora cargar SPL Token
            loadScriptWithRetry(
              'https://cdn.jsdelivr.net/npm/@solana/spl-token@0.3.6/lib/index.iife.min.js',
              'https://unpkg.com/@solana/spl-token@0.3.6/lib/index.iife.min.js',
              function() {
                window.SolanaQuemadorState.splTokenLoaded = true;
                showStatus('SPL Token cargado correctamente.');
                checkAndInitialize();
              },
              function() {
                window.SolanaQuemadorState.loadingStatus = 'failed';
                showStatus('No se pudo cargar la biblioteca SPL Token. Intenta actualizar la página.', true);
              }
            );
          },
          function() {
            window.SolanaQuemadorState.loadingStatus = 'failed';
            showStatus('No se pudo cargar la biblioteca Web3. Intenta actualizar la página.', true);
          }
        );
      });

      // Función para inicializar la aplicación
      function initSolanaBurner() {
        // Inicializar la aplicación
        const SolanaBurner = {
          elements: {
            // Elementos originales
            error: document.getElementById('stb-error'),
            walletConnected: document.querySelector('.stb-wallet-connected'),
            walletButtons: document.querySelector('.stb-wallet-buttons'),
            walletAddress: document.getElementById('stb-wallet-address'),
            walletType: document.getElementById('stb-wallet-type'),
            disconnectBtn: document.getElementById('stb-disconnect-btn'),
            connectPhantomBtn: document.getElementById('stb-connect-phantom'),
            connectSolflareBtn: document.getElementById('stb-connect-solflare'),
            tokensLoading: document.getElementById('stb-tokens-loading'),
            tokensConnectWallet: document.getElementById('stb-tokens-connect-wallet'),
            tokensEmpty: document.getElementById('stb-tokens-empty'),
            tokensList: document.getElementById('stb-tokens-list'),
            burnBtn: document.getElementById('stb-burn-btn'),
            yearSpan: document.getElementById('stb-year'),
            confirmDialog: document.getElementById('stb-confirm-dialog'),
            confirmTokensList: document.getElementById('stb-confirm-tokens-list'),
            confirmCancelBtn: document.getElementById('stb-confirm-cancel'),
            confirmProceedBtn: document.getElementById('stb-confirm-proceed'),
            txStatus: document.getElementById('stb-tx-status'),
            txMessage: document.getElementById('stb-tx-message'),
            txHash: document.getElementById('stb-tx-hash'),
            
            // Elementos de donación
            donationContainer: document.getElementById('stb-donation-container'),
            donationAmounts: document.querySelectorAll('.stb-donation-amount'),
            donationAddress: document.getElementById('stb-donation-address'),
            donateBtn: document.getElementById('stb-donate-btn'),
            thankYou: document.getElementById('stb-thank-you')
          },
          state: {
            wallet: null,
            tokens: [],
            selectedTokens: [],
            connection: null,
            pendingBurn: false,
            selectedDonationAmount: 0.01,
            // ⚠️ IMPORTANTE: CAMBIA ESTA DIRECCIÓN POR TU WALLET ⚠️
            donationAddress: '8W48xBQd9wRfm6Vy6rToeQPRduGpmj6i5qL4hW2AFu9a',
            rpcEndpoints: [
              'https://api.mainnet-beta.solana.com',
              'https://solana-api.projectserum.com',
              'https://rpc.ankr.com/solana',
              'https://ssc-dao.genesysgo.net'
            ],
            currentEndpointIndex: 0
          },
    
          init() {
            // Inicializar la conexión a Solana
            this.initSolanaConnection();
            this.setupEventListeners();
            this.updateUI();
            this.elements.yearSpan.textContent = new Date().getFullYear();
            
            // Mostrar la dirección de donación
            this.elements.donationAddress.textContent = this.state.donationAddress;
            
            // Mostrar mensaje de éxito
            console.log("Aplicación inicializada correctamente");
          },
          
          // El resto del código se mantiene igual...
        };

        // Inicializar la aplicación
        try {
          console.log("Iniciando aplicación...");
          SolanaBurner.init();
          console.log("Aplicación iniciada correctamente");
        } catch (err) {
          console.error("Error al iniciar la aplicación:", err);
          showStatus("Error al iniciar la aplicación: " + err.message, true);
        }
      }
    </script>

    <!-- Script auxiliar para garantizar la carga -->
    <script>
      // Verificar el estado de carga después de un tiempo
      setTimeout(function() {
        if (window.SolanaQuemadorState && window.SolanaQuemadorState.loadingStatus === 'pending') {
          console.warn("La carga de dependencias está tardando demasiado");
          document.getElementById('stb-error').textContent = 'La carga está tardando más de lo esperado. Por favor, actualiza la página.';
          document.getElementById('stb-error').style.display = 'block';
        }
      }, 10000);
    </script>
</body>
</html>
