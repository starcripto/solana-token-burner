<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quemador de Tokens Solana</title>
    <!-- Estilos originales (sin cambios) -->
    <style>
        /* Mantén tus estilos CSS originales aquí */
    </style>

    <!-- Scripts necesarios -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
    <script src="https://unpkg.com/@solana/spl-token@latest/lib/index.iife.js"></script>
</head>
<body>
    <div class="background-pattern"></div>
    <div id="root">
        <div style="text-align: center; padding-top: 100px; color: white;">
            Cargando la aplicación...
        </div>
    </div>

    <script type="text/babel">
        const { Connection, PublicKey, clusterApiUrl } = window.SolanaWeb3;
        const { getAssociatedTokenAddress, burn, TOKEN_PROGRAM_ID } = window.SolanaSplToken;

        function App() {
            const [wallet, setWallet] = React.useState(null);
            const [loading, setLoading] = React.useState(false);
            const [error, setError] = React.useState(null);
            const [selectedTokens, setSelectedTokens] = React.useState([]);
            const [availableTokens, setAvailableTokens] = React.useState([]);
            const [lastUpdated, setLastUpdated] = React.useState(null);

            // Conexión a Mainnet
            const connection = new Connection("https://api.mainnet-beta.solana.com", "confirmed");

            // Conectar a Phantom
            const connectPhantom = async () => {
                setLoading(true);
                setError(null);
                try {
                    if (!window?.solana?.isPhantom) {
                        window.open("https://phantom.app/", "_blank");
                        throw new Error("Por favor instala Phantom wallet");
                    }

                    const response = await window.solana.connect();
                    const publicKey = response.publicKey.toString();
                    setWallet({ address: publicKey, type: "phantom", publicKey: response.publicKey });

                    // Obtener tokens reales
                    await loadTokens(publicKey);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            // Conectar a Solflare
            const connectSolflare = async () => {
                setLoading(true);
                setError(null);
                try {
                    if (!window?.solflare) {
                        window.open("https://solflare.com/", "_blank");
                        throw new Error("Por favor instala Solflare wallet");
                    }

                    await window.solflare.connect();
                    const publicKey = window.solflare.publicKey.toString();
                    setWallet({ address: publicKey, type: "solflare", publicKey: window.solflare.publicKey });

                    // Obtener tokens reales
                    await loadTokens(publicKey);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            // Cargar tokens reales del wallet
            const loadTokens = async (publicKey) => {
                try {
                    const pubKey = new PublicKey(publicKey);
                    const tokenAccounts = await connection.getTokenAccountsByOwner(pubKey, { programId: TOKEN_PROGRAM_ID });

                    const tokens = await Promise.all(tokenAccounts.value.map(async (account) => {
                        const accountInfo = await connection.getTokenAccountBalance(account.pubkey);
                        const mint = new PublicKey(account.account.data.parsed.info.mint);
                        return {
                            mint: mint.toString(),
                            symbol: `Token (${mint.toString().slice(0, 6)}...)`, // Simplificado, podrías usar un registro de tokens para símbolos
                            balance: accountInfo.value.uiAmountString,
                            decimals: accountInfo.value.decimals,
                            account: account.pubkey.toString()
                        };
                    }));

                    setAvailableTokens(tokens);
                    setLastUpdated(new Date().toLocaleTimeString());
                } catch (err) {
                    setError("Error al cargar tokens: " + err.message);
                }
            };

            // Desconectar wallet
            const handleDisconnect = () => {
                if (wallet?.type === "phantom") window.solana.disconnect();
                if (wallet?.type === "solflare") window.solflare.disconnect();
                setWallet(null);
                setAvailableTokens([]);
                setSelectedTokens([]);
                setError(null);
            };

            // Quemar tokens reales
            const handleBurn = async () => {
                if (!wallet || selectedTokens.length === 0) {
                    setError("Selecciona tokens para quemar");
                    return;
                }

                setLoading(true);
                setError(null);

                try {
                    const signer = wallet.type === "phantom" ? window.solana : window.solflare;

                    for (const mint of selectedTokens) {
                        const token = availableTokens.find(t => t.mint === mint);
                        const tokenAccount = new PublicKey(token.account);
                        const mintPubkey = new PublicKey(mint);

                        // Crear instrucción de quema
                        const burnInstruction = await burn({
                            connection,
                            payer: signer,
                            account: tokenAccount,
                            mint: mintPubkey,
                            owner: signer,
                            amount: BigInt(Math.floor(parseFloat(token.balance) * Math.pow(10, token.decimals))),
                        });

                        alert(`Tokens ${token.symbol} quemados exitosamente.`);
                    }

                    // Recargar tokens después de quemar
                    await loadTokens(wallet.address);
                    setSelectedTokens([]);
                } catch (err) {
                    setError("Error al quemar tokens: " + err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="container">
                    <div className="header">
                        <h1 className="title">QUEMADOR DE TOKENS SOLANA</h1>
                        <p>Conecta tu wallet para empezar (Mainnet)</p>
                    </div>
                    
                    {error && <div className="error-message">{error}</div>}
                    
                    <div className="grid">
                        <div className="panel">
                            <h2 style={{color: '#ff00ff'}}>Estado del Wallet</h2>
                            {wallet ? (
                                <div>
                                    <p>Conectado: {wallet.address.slice(0, 6)}...{wallet.address.slice(-4)}</p>
                                    <p>Tipo: {wallet.type}</p>
                                    <button onClick={handleDisconnect} className="button disconnect-button">Desconectar</button>
                                </div>
                            ) : (
                                <div>
                                    <button onClick={connectPhantom} disabled={loading} className="button phantom-button">
                                        {loading ? "Conectando..." : "Conectar Phantom"}
                                    </button>
                                    <button onClick={connectSolflare} disabled={loading} className="button solflare-button" style={{marginTop: '10px'}}>
                                        {loading ? "Conectando..." : "Conectar Solflare"}
                                    </button>
                                </div>
                            )}
                        </div>
                        
                        <div className="panel">
                            <h2 style={{color: '#00ff00'}}>Tokens Disponibles</h2>
                            {loading ? (
                                <p>Cargando tokens...</p>
                            ) : wallet ? (
                                availableTokens.length > 0 ? (
                                    <div>
                                        <div className="token-list">
                                            {availableTokens.map(token => (
                                                <div key={token.mint} className="token-item">
                                                    <input 
                                                        type="checkbox"
                                                        className="checkbox"
                                                        checked={selectedTokens.includes(token.mint)}
                                                        onChange={(e) => {
                                                            if (e.target.checked) {
                                                                setSelectedTokens([...selectedTokens, token.mint]);
                                                            } else {
                                                                setSelectedTokens(selectedTokens.filter(t => t !== token.mint));
                                                            }
                                                        }}
                                                    />
                                                    <span>{token.symbol} - {token.balance}</span>
                                                </div>
                                            ))}
                                        </div>
                                        <button 
                                            disabled={selectedTokens.length === 0 || loading}
                                            onClick={handleBurn}
                                            className="button burn-button"
                                        >
                                            {loading ? "Procesando..." : `Quemar ${selectedTokens.length} Token${selectedTokens.length !== 1 ? "s" : ""}`}
                                        </button>
                                    </div>
                                ) : (
                                    <p>No se encontraron tokens en este wallet</p>
                                )
                            ) : (
                                <p>Conecta tu wallet para ver tus tokens</p>
                            )}
                            {lastUpdated && (
                                <p style={{fontSize: '12px', color: '#666', marginTop: '10px'}}>
                                    Última actualización: {lastUpdated}
                                </p>
                            )}
                        </div>
                    </div>
                    
                    <footer className="footer">
                        <p>Ejecutando en Solana Mainnet • {new Date().getFullYear()}</p>
                    </footer>
                </div>
            );
        }

        try {
            const container = document.getElementById('root');
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
        } catch (error) {
            document.getElementById('root').innerHTML = `
                <div style="text-align: center; padding: 20px; color: red;">
                    Error al cargar la aplicación: ${error.message}
                </div>
            `;
        }
    </script>
</body>
</html>
