<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quemador de Tokens Solana</title>
    <!-- Estilos básicos primero -->
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: black;
            color: white;
            margin: 0;
            padding: 0;
        }
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .panel {
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            flex: 1;
            min-width: 300px;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        .title {
            color: #00FFFF;
            font-size: 36px;
            font-weight: bold;
        }
        .button {
            background-color: transparent;
            border: 1px solid;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            font-size: 16px;
        }
        .phantom-button {
            color: #00FFFF;
            border-color: #00FFFF;
        }
        .phantom-button:hover {
            background-color: rgba(0, 255, 255, 0.1);
        }
        .solflare-button {
            color: #FFA500;
            border-color: #FFA500;
        }
        .solflare-button:hover {
            background-color: rgba(255, 165, 0, 0.1);
        }
        .burn-button {
            color: #ff0000;
            border-color: #ff0000;
        }
        .burn-button:hover {
            background-color: rgba(255, 0, 0, 0.1);
        }
        .burn-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .disconnect-button {
            color: #ff5555;
            border-color: #ff5555;
        }
        .disconnect-button:hover {
            background-color: rgba(255, 85, 85, 0.1);
        }
        .error-message {
            background-color: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff5555;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        .token-item {
            padding: 10px;
            border: 1px solid #333;
            margin-bottom: 5px;
            border-radius: 5px;
            display: flex;
            align-items: center;
        }
        .token-item:hover {
            border-color: #555;
        }
        .checkbox {
            margin-right: 10px;
        }
        .token-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            color: #666;
            font-size: 14px;
        }
        /* Grid pattern background */
        .background-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(to right, #1a1a1a 1px, transparent 1px),
                linear-gradient(to bottom, #1a1a1a 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: -1;
        }
    </style>
    
    <!-- Scripts necesarios -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/@solana/spl-token@latest/lib/index.iife.min.js"></script>
</head>
<body>
    <!-- Patrón de fondo -->
    <div class="background-pattern"></div>
    
    <!-- Contenedor principal -->
    <div id="root">
        <!-- Este mensaje desaparecerá cuando React se cargue correctamente -->
        <div style="text-align: center; padding-top: 100px; color: white;">
            Cargando la aplicación...
        </div>
    </div>

    <script type="text/babel">
        // Asegurarse de que las bibliotecas estén accesibles
        const solanaWeb3 = window.solanaWeb3;
        const splToken = window.splToken;

        function App() {
            const [wallet, setWallet] = React.useState(null);
            const [loading, setLoading] = React.useState(false);
            const [error, setError] = React.useState(null);
            const [selectedTokens, setSelectedTokens] = React.useState([]);
            const [availableTokens, setAvailableTokens] = React.useState([]);
            const [lastUpdated, setLastUpdated] = React.useState(null);

            // Función para obtener tokens
            const fetchTokens = async (publicKey) => {
                try {
                    setLoading(true);
                    
                    // Crear conexión a Solana Mainnet
                    const connection = new solanaWeb3.Connection(
                        solanaWeb3.clusterApiUrl('mainnet-beta')
                    );
                    
                    // Obtener cuentas de token
                    const tokenAccounts = await connection.getParsedTokenAccountsByOwner(
                        publicKey,
                        { 
                            programId: new solanaWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA") 
                        }
                    );
                    
                    // Procesar las cuentas de token
                    const tokens = tokenAccounts.value
                        .map(accountInfo => {
                            const parsedInfo = accountInfo.account.data.parsed.info;
                            return {
                                mint: parsedInfo.mint,
                                symbol: parsedInfo.mint.slice(0, 4), // Usamos los primeros caracteres como símbolo
                                balance: parsedInfo.tokenAmount.uiAmount,
                                decimals: parsedInfo.tokenAmount.decimals,
                                tokenAccount: accountInfo.pubkey.toString()
                            };
                        })
                        .filter(token => token.balance > 0); // Solo tokens con saldo positivo
                    
                    setAvailableTokens(tokens);
                    setLastUpdated(new Date().toLocaleTimeString());
                    
                    console.log(`Se encontraron ${tokens.length} tokens`);
                } catch (err) {
                    console.error("Error al obtener tokens:", err);
                    setError(`Error al cargar tokens: ${err.message}`);
                } finally {
                    setLoading(false);
                }
            };

            // Función para conectar wallet
            const handleConnect = async (type) => {
                setLoading(true);
                setError(null);
                
                try {
                    // Verificar si el wallet está instalado
                    if (type === "phantom" && !window?.solana?.isPhantom) {
                        window.open("https://phantom.app/", "_blank");
                        throw new Error("Por favor instala Phantom wallet");
                    }
                    if (type === "solflare" && !window?.solflare) {
                        window.open("https://solflare.com", "_blank");
                        throw new Error("Por favor instala Solflare wallet");
                    }
                    
                    let provider;
                    let publicKey;
                    
                    // Obtener proveedor según el tipo de wallet
                    if (type === "phantom") {
                        provider = window.solana;
                    } else {
                        provider = window.solflare;
                    }
                    
                    // Intentar conectar
                    try {
                        if (!provider.isConnected) {
                            const res = await provider.connect();
                            publicKey = res.publicKey || provider.publicKey;
                        } else {
                            publicKey = provider.publicKey;
                        }
                    } catch (e) {
                        throw new Error(`Error al conectar: ${e.message}`);
                    }
                    
                    if (!publicKey) {
                        throw new Error("No se pudo obtener la clave pública");
                    }
                    
                    // Wallet conectado exitosamente
                    const address = publicKey.toString();
                    setWallet({
                        address,
                        type,
                        publicKey
                    });
                    
                    // Obtener tokens reales
                    await fetchTokens(publicKey);
                    
                } catch (err) {
                    console.error("Error:", err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            // Función para desconectar
            const handleDisconnect = () => {
                setWallet(null);
                setAvailableTokens([]);
                setSelectedTokens([]);
                setError(null);
            };

            // Función para quemar tokens reales
            const handleBurn = async () => {
                if (!wallet || selectedTokens.length === 0) {
                    setError("Selecciona tokens para quemar");
                    return;
                }
                
                setLoading(true);
                setError(null);
                
                try {
                    const connection = new solanaWeb3.Connection(
                        solanaWeb3.clusterApiUrl('mainnet-beta')
                    );
                    
                    let burnedTokens = 0;
                    let failedTokens = 0;
                    
                    for (const tokenMint of selectedTokens) {
                        try {
                            const token = availableTokens.find(t => t.mint === tokenMint);
                            if (!token) continue;
                            
                            // Obtener el proveedor del wallet correcto
                            const walletProvider = wallet.type === "phantom" ? window.solana : window.solflare;
                            
                            // Obtener la cuenta de token asociada
                            const tokenAccountAddress = await splToken.getAssociatedTokenAddress(
                                new solanaWeb3.PublicKey(token.mint),
                                wallet.publicKey
                            );
                            
                            // Calcular la cantidad a quemar (convertir de unidades UI a lamports)
                            const amount = Math.floor(parseFloat(token.balance) * Math.pow(10, token.decimals));
                            
                            // Crear la instrucción de quemado
                            const burnInstruction = splToken.createBurnCheckedInstruction(
                                tokenAccountAddress,                    // cuenta de token
                                new solanaWeb3.PublicKey(token.mint),   // mint del token
                                wallet.publicKey,                       // propietario
                                amount,                                 // cantidad a quemar
                                token.decimals                          // decimales
                            );
                            
                            // Crear y configurar la transacción
                            const transaction = new solanaWeb3.Transaction().add(burnInstruction);
                            transaction.feePayer = wallet.publicKey;
                            
                            // Obtener el blockhash reciente
                            const { blockhash } = await connection.getLatestBlockhash();
                            transaction.recentBlockhash = blockhash;
                            
                            // Firmar y enviar la transacción
                            const signed = await walletProvider.signTransaction(transaction);
                            const signature = await connection.sendRawTransaction(signed.serialize());
                            
                            // Confirmar la transacción
                            await connection.confirmTransaction(signature, 'confirmed');
                            
                            console.log(`Token quemado exitosamente: ${token.symbol}, Tx: ${signature}`);
                            burnedTokens++;
                        } catch (err) {
                            console.error(`Error al quemar token ${tokenMint}:`, err);
                            failedTokens++;
                        }
                    }
                    
                    // Actualizar UI después de quemar
                    if (burnedTokens > 0) {
                        // Recargar los tokens después de quemar
                        await fetchTokens(wallet.publicKey);
                        setSelectedTokens([]);
                        
                        alert(`¡${burnedTokens} token(s) quemados exitosamente en Solana Mainnet!`);
                    } else {
                        setError("No se pudo quemar ningún token. Revisa la consola para más detalles.");
                    }
                } catch (err) {
                    console.error("Error en el proceso de quemado:", err);
                    setError(`Error: ${err.message}`);
                } finally {
                    setLoading(false);
                }
            };

            // Limpiar errores al cambiar wallet o tokens seleccionados
            React.useEffect(() => {
                setError(null);
            }, [wallet, selectedTokens]);

            return (
                <div className="container">
                    <div className="header">
                        <h1 className="title">QUEMADOR DE TOKENS SOLANA</h1>
                        <p>Conecta tu wallet para empezar</p>
                    </div>
                    
                    {error && <div className="error-message">{error}</div>}
                    
                    <div className="grid">
                        <div className="panel">
                            <h2 style={{color: '#ff00ff'}}>Estado del Wallet</h2>
                            
                            {wallet ? (
                                <div>
                                    <p>
                                        Conectado: {wallet.address.slice(0, 6)}...{wallet.address.slice(-4)}
                                    </p>
                                    <p>Tipo: {wallet.type}</p>
                                    <button 
                                        onClick={handleDisconnect}
                                        className="button disconnect-button"
                                    >
                                        Desconectar
                                    </button>
                                </div>
                            ) : (
                                <div>
                                    <button 
                                        onClick={() => handleConnect("phantom")}
                                        disabled={loading}
                                        className="button phantom-button"
                                    >
                                        {loading ? "Conectando..." : "Conectar Phantom"}
                                    </button>
                                    <button 
                                        onClick={() => handleConnect("solflare")}
                                        disabled={loading}
                                        className="button solflare-button"
                                        style={{marginTop: '10px'}}
                                    >
                                        {loading ? "Conectando..." : "Conectar Solflare"}
                                    </button>
                                </div>
                            )}
                        </div>
                        
                        <div className="panel">
                            <h2 style={{color: '#00ff00'}}>Tokens Disponibles</h2>
                            
                            {loading ? (
                                <p>Cargando tokens...</p>
                            ) : wallet ? (
                                availableTokens.length > 0 ? (
                                    <div>
                                        <div className="token-list">
                                            {availableTokens.map(token => (
                                                <div key={token.mint} className="token-item">
                                                    <input 
                                                        type="checkbox"
                                                        className="checkbox"
                                                        checked={selectedTokens.includes(token.mint)}
                                                        onChange={(e) => {
                                                            if (e.target.checked) {
                                                                setSelectedTokens([...selectedTokens, token.mint]);
                                                            } else {
                                                                setSelectedTokens(selectedTokens.filter(t => t !== token.mint));
                                                            }
                                                        }}
                                                    />
                                                    <span>{token.symbol} - {token.balance}</span>
                                                </div>
                                            ))}
                                        </div>
                                        
                                        <button 
                                            disabled={selectedTokens.length === 0 || loading}
                                            onClick={handleBurn}
                                            className="button burn-button"
                                        >
                                            {loading ? "Quemando..." : `Quemar ${selectedTokens.length} Token${selectedTokens.length !== 1 ? "s" : ""}`}
                                        </button>
                                    </div>
                                ) : (
                                    <p>No se encontraron tokens en este wallet</p>
                                )
                            ) : (
                                <p>Conecta tu wallet para ver tus tokens</p>
                            )}
                            
                            {lastUpdated && (
                                <p style={{fontSize: '12px', color: '#666', marginTop: '10px'}}>
                                    Última actualización: {lastUpdated}
                                </p>
                            )}
                        </div>
                    </div>
                    
                    <footer className="footer">
                        Ejecutando en Solana Mainnet • {new Date().getFullYear()}
                    </footer>
                </div>
            );
        }

        // Montar el componente con un try-catch para capturar errores
        try {
            const container = document.getElementById('root');
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
            console.log("Aplicación montada correctamente");
        } catch (error) {
            console.error("Error al montar la aplicación:", error);
            document.getElementById('root').innerHTML = `
                <div style="text-align: center; padding: 20px; color: red;">
                    Error al cargar la aplicación: ${error.message}
                </div>
            `;
        }
    </script>
</body>
</html>
