<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quemador de Tokens Solana</title>
    <style>
        /* Los mismos estilos que antes... */
        body {
            font-family: Arial, sans-serif;
            background-color: #222;
            color: white;
            margin: 0;
            padding: 0;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            padding: 20px;
            background-color: #000;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .header h1 {
            color: #00FFFF;
            margin: 0;
            padding: 0;
        }
        
        .card {
            background-color: #333;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card h2 {
            color: #FF00FF;
            margin-top: 0;
        }
        
        .button-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        button {
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #555;
            background-color: #444;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }
        
        #connect-phantom {
            border-color: #00FFFF;
            color: #00FFFF;
        }
        
        #connect-solflare {
            border-color: #FFA500;
            color: #FFA500;
        }
        
        #status {
            padding: 10px;
            background-color: rgba(255, 0, 0, 0.2);
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        
        #wallet-info {
            display: none;
        }
        
        #footer {
            text-align: center;
            font-size: 14px;
            color: #666;
            margin-top: 20px;
        }
        
        #tokens-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .token-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 5px;
            margin-bottom: 8px;
            background-color: #444;
        }
        
        .token-item:hover {
            background-color: #555;
        }
        
        .loading {
            text-align: center;
            margin: 20px 0;
            display: none;
        }
        
        #burn-button {
            background-color: #500;
            color: #f99;
            border: 1px solid #a00;
            margin-top: 15px;
            display: none;
        }
        
        #burn-button:hover {
            background-color: #700;
        }
        
        .checkbox {
            margin-right: 10px;
        }
        
        #library-status {
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>QUEMADOR DE TOKENS SOLANA</h1>
            <p>Conecta tu wallet para comenzar</p>
        </div>
        
        <div id="status"></div>
        <div id="library-status">Cargando bibliotecas de Solana...</div>
        
        <div class="card">
            <h2>Conectar Wallet</h2>
            <div class="button-container">
                <button id="connect-phantom" disabled>Conectar con Phantom</button>
                <button id="connect-solflare" disabled>Conectar con Solflare</button>
            </div>
            
            <div id="wallet-info">
                <p>Conectado: <span id="wallet-address">No conectado</span></p>
                <p>Tipo: <span id="wallet-type">Ninguno</span></p>
                <button id="disconnect">Desconectar</button>
            </div>
        </div>
        
        <div class="card">
            <h2>Tokens Disponibles</h2>
            <p id="tokens-message">Conecta tu wallet para ver tus tokens</p>
            <div class="loading" id="loading">Cargando tokens...</div>
            <div id="tokens-list"></div>
            <button id="burn-button">Quemar tokens seleccionados</button>
        </div>
        
        <div id="footer">
            Ejecutando en Solana Mainnet • <span id="year">2023</span>
        </div>
    </div>

    <script>
        // Actualizar el año actual
        document.getElementById('year').textContent = new Date().getFullYear();
        
        // Estado de la aplicación
        const appState = {
            walletConnected: false,
            walletAddress: null,
            walletType: null,
            walletProvider: null,
            tokens: [],
            selectedTokens: [],
            connection: null,
            libraries: {
                web3Loaded: false,
                splTokenLoaded: false
            }
        };
        
        // Cargador de bibliotecas
        function loadLibraries() {
            const libraryStatus = document.getElementById('library-status');
            
            // Cargar primero Web3.js
            libraryStatus.textContent = 'Cargando Solana Web3.js...';
            
            // Crear elemento de script y cargar Web3.js
            const web3Script = document.createElement('script');
            web3Script.src = 'https://cdn.jsdelivr.net/npm/@solana/web3.js@1.73.0/lib/index.iife.min.js';
            
            web3Script.onload = function() {
                console.log('Solana Web3.js cargado correctamente');
                appState.libraries.web3Loaded = true;
                libraryStatus.textContent = 'Web3.js cargado. Cargando SPL Token...';
                
                // Una vez que Web3.js está cargado, cargar SPL Token
                const splTokenScript = document.createElement('script');
                splTokenScript.src = 'https://cdn.jsdelivr.net/npm/@solana/spl-token@0.3.6/lib/index.iife.min.js';
                
                splTokenScript.onload = function() {
                    console.log('SPL Token cargado correctamente');
                    appState.libraries.splTokenLoaded = true;
                    libraryStatus.textContent = 'Bibliotecas listas. Ahora puedes conectar tu wallet.';
                    
                    // Habilitar botones
                    document.getElementById('connect-phantom').disabled = false;
                    document.getElementById('connect-solflare').disabled = false;
                    
                    // Inicializar conexión de Solana
                    initConnection();
                };
                
                splTokenScript.onerror = function() {
                    console.error('Error al cargar SPL Token');
                    libraryStatus.textContent = 'Error al cargar SPL Token. Intenta recargar la página.';
                    libraryStatus.style.backgroundColor = 'rgba(255, 0, 0, 0.2)';
                };
                
                document.body.appendChild(splTokenScript);
            };
            
            web3Script.onerror = function() {
                console.error('Error al cargar Web3.js');
                libraryStatus.textContent = 'Error al cargar Solana Web3.js. Intenta recargar la página.';
                libraryStatus.style.backgroundColor = 'rgba(255, 0, 0, 0.2)';
            };
            
            document.body.appendChild(web3Script);
        }
        
        // Funciones básicas
        function showStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.style.display = 'block';
            status.style.backgroundColor = isError ? 'rgba(255, 0, 0, 0.2)' : 'rgba(0, 255, 0, 0.2)';
            
            if (!isError) {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
            
            console.log(`${isError ? 'ERROR' : 'INFO'}: ${message}`);
        }
        
        function updateWalletUI(connected, address = null, type = null) {
            const walletInfo = document.getElementById('wallet-info');
            const walletAddress = document.getElementById('wallet-address');
            const walletType = document.getElementById('wallet-type');
            const buttonContainer = document.querySelector('.button-container');
            const tokensMessage = document.getElementById('tokens-message');
            
            if (connected && address) {
                walletInfo.style.display = 'block';
                buttonContainer.style.display = 'none';
                walletAddress.textContent = `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
                walletType.textContent = type;
                tokensMessage.style.display = 'none';
                
                // Actualizar estado
                appState.walletConnected = true;
                appState.walletAddress = address;
                appState.walletType = type;
                
                // Cargar tokens
                fetchTokens();
            } else {
                walletInfo.style.display = 'none';
                buttonContainer.style.display = 'flex';
                tokensMessage.style.display = 'block';
                tokensMessage.textContent = 'Conecta tu wallet para ver tus tokens';
                document.getElementById('tokens-list').innerHTML = '';
                document.getElementById('tokens-list').style.display = 'none';
                document.getElementById('burn-button').style.display = 'none';
                
                // Reiniciar estado
                appState.walletConnected = false;
                appState.walletAddress = null;
                appState.walletType = null;
                appState.walletProvider = null;
                appState.tokens = [];
                appState.selectedTokens = [];
            }
        }
        
        // Inicializar conexión a Solana
        function initConnection() {
            try {
                if (!window.solanaWeb3) {
                    showStatus('Error: Biblioteca Solana Web3 no disponible', true);
                    return false;
                }
                
                const { Connection, clusterApiUrl } = solanaWeb3;
                appState.connection = new Connection(clusterApiUrl('mainnet-beta'));
                console.log('Conexión a Solana inicializada');
                return true;
            } catch (error) {
                console.error('Error al inicializar conexión:', error);
                showStatus('Error al conectar con Solana: ' + error.message, true);
                return false;
            }
        }
        
        // Obtener tokens del wallet
        async function fetchTokens() {
            if (!appState.walletConnected || !appState.walletAddress) {
                showStatus('No hay wallet conectado', true);
                return;
            }
            
            if (!appState.connection) {
                if (!initConnection()) {
                    return;
                }
            }
            
            // Verificar que las bibliotecas estén cargadas
            if (!window.solanaWeb3 || !window.splToken) {
                showStatus('Las bibliotecas necesarias no están cargadas correctamente', true);
                return;
            }
            
            try {
                // Mostrar carga
                document.getElementById('loading').style.display = 'block';
                document.getElementById('tokens-list').style.display = 'none';
                
                const { PublicKey } = solanaWeb3;
                
                // Obtener cuentas de token
                console.log('Consultando tokens para:', appState.walletAddress);
                const walletPublicKey = new PublicKey(appState.walletAddress);
                
                const tokenAccounts = await appState.connection.getParsedTokenAccountsByOwner(
                    walletPublicKey,
                    {
                        programId: new PublicKey('TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA')
                    }
                );
                
                console.log('Cuentas de token encontradas:', tokenAccounts.value.length);
                
                // Procesar tokens
                const tokens = tokenAccounts.value
                    .map(account => {
                        const parsedInfo = account.account.data.parsed.info;
                        return {
                            mint: parsedInfo.mint,
                            amount: parsedInfo.tokenAmount.uiAmount,
                            decimals: parsedInfo.tokenAmount.decimals,
                            tokenAccount: account.pubkey.toString()
                        };
                    })
                    .filter(token => token.amount > 0);
                
                appState.tokens = tokens;
                
                // Actualizar UI
                document.getElementById('loading').style.display = 'none';
                
                if (tokens.length > 0) {
                    renderTokens(tokens);
                    document.getElementById('tokens-list').style.display = 'block';
                    document.getElementById('burn-button').style.display = 'block';
                    showStatus(`Se encontraron ${tokens.length} tokens`);
                } else {
                    const tokensMessage = document.getElementById('tokens-message');
                    tokensMessage.style.display = 'block';
                    tokensMessage.textContent = 'No se encontraron tokens en este wallet';
                }
                
                console.log('Tokens cargados:', tokens.length);
            } catch (error) {
                console.error('Error al obtener tokens:', error);
                showStatus('Error al cargar tokens: ' + error.message, true);
                document.getElementById('loading').style.display = 'none';
                
                const tokensMessage = document.getElementById('tokens-message');
                tokensMessage.style.display = 'block';
                tokensMessage.textContent = 'Error al cargar tokens: ' + error.message;
            }
        }
        
        // Renderizar lista de tokens
        function renderTokens(tokens) {
            const tokensList = document.getElementById('tokens-list');
            tokensList.innerHTML = '';
            
            tokens.forEach((token, index) => {
                const tokenItem = document.createElement('div');
                tokenItem.className = 'token-item';
                
                // Crear abreviatura del mint
                const shortMint = token.mint.substring(0, 4) + '...' + token.mint.substring(token.mint.length - 4);
                
                tokenItem.innerHTML = `
                    <div>
                        <input type="checkbox" class="checkbox" data-index="${index}" id="token-${index}">
                        <label for="token-${index}">${shortMint}</label>
                    </div>
                    <div>${token.amount}</div>
                `;
                
                tokensList.appendChild(tokenItem);
                
                // Añadir evento al checkbox
                tokenItem.querySelector('input').addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    if (e.target.checked) {
                        appState.selectedTokens.push(tokens[index]);
                    } else {
                        appState.selectedTokens = appState.selectedTokens.filter(t => t.mint !== tokens[index].mint);
                    }
                    
                    // Actualizar botón de quemar
                    updateBurnButton();
                });
            });
        }
        
        // Actualizar botón de quemar
        function updateBurnButton() {
            const burnButton = document.getElementById('burn-button');
            burnButton.textContent = appState.selectedTokens.length > 0 
                ? `Quemar ${appState.selectedTokens.length} token(s)` 
                : 'Selecciona tokens para quemar';
            burnButton.disabled = appState.selectedTokens.length === 0;
        }
        
        // Detectar Phantom
        document.getElementById('connect-phantom').addEventListener('click', async () => {
            try {
                if (typeof window.solana === 'undefined') {
                    showStatus('Phantom no está instalado. Por favor, instálalo primero.', true);
                    window.open('https://phantom.app/', '_blank');
                    return;
                }
                
                if (!appState.connection && !initConnection()) {
                    return;
                }
                
                showStatus('Conectando con Phantom...');
                const resp = await window.solana.connect();
                const address = resp.publicKey.toString();
                
                // Guardar proveedor
                appState.walletProvider = window.solana;
                
                updateWalletUI(true, address, 'Phantom');
                showStatus('Conectado con Phantom');
            } catch (error) {
                console.error('Error al conectar con Phantom:', error);
                showStatus('Error: ' + (error.message || 'Error desconocido'), true);
            }
        });
        
        // Detectar Solflare
        document.getElementById('connect-solflare').addEventListener('click', async () => {
            try {
                if (typeof window.solflare === 'undefined') {
                    showStatus('Solflare no está instalado. Por favor, instálalo primero.', true);
                    window.open('https://solflare.com/', '_blank');
                    return;
                }
                
                if (!appState.connection && !initConnection()) {
                    return;
                }
                
                showStatus('Conectando con Solflare...');
                await window.solflare.connect();
                const address = window.solflare.publicKey.toString();
                
                // Guardar proveedor
                appState.walletProvider = window.solflare;
                
                updateWalletUI(true, address, 'Solflare');
                showStatus('Conectado con Solflare');
            } catch (error) {
                console.error('Error al conectar con Solflare:', error);
                showStatus('Error: ' + (error.message || 'Error desconocido'), true);
            }
        });
        
        // Desconectar wallet
        document.getElementById('disconnect').addEventListener('click', () => {
            if (appState.walletProvider && appState.walletProvider.disconnect) {
                try {
                    appState.walletProvider.disconnect();
                } catch (e) {
                    console.warn('Error al desconectar wallet:', e);
                }
            }
            
            updateWalletUI(false);
            showStatus('Wallet desconectado');
        });
        
        // Botón para quemar tokens
        document.getElementById('burn-button').addEventListener('click', () => {
            showStatus('Función de quema próximamente');
        });

        // Cargar las bibliotecas al iniciar
        document.addEventListener('DOMContentLoaded', () => {
            loadLibraries();
        });
    </script>
</body>
</html>
